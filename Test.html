<!-- Đơn Hàng -->
<div class="donhang">
  <table class="table-header">
      <tr>
          <!-- Theo độ rộng của table content -->
          <th title="Sắp xếp" style="width: 5%" onclick="sortDonHangTable('stt')">Stt <i class="fa fa-sort"></i></th>
          <th title="Sắp xếp" style="width: 7%" onclick="sortDonHangTable('madon')">Mã đơn <i class="fa fa-sort"></i></th>
          <th title="Sắp xếp" style="width: 13%" onclick="sortDonHangTable('khach')">Khách hàng<i class="fa fa-sort"></i></th>
          <th title="Sắp xếp" style="width: 20%" onclick="sortDonHangTable('sanpham')">Sản phẩm <i class="fa fa-sort"></i></th>
          <th title="Sắp xếp" style="width: 15%" onclick="sortDonHangTable('tongtien')">Tổng tiền <i class="fa fa-sort"></i></th>
          <th title="Sắp xếp" style="width: 10%" onclick="sortDonHangTable('ngaygio')">Ngày giờ <i class="fa fa-sort"></i></th>
          <th title="Sắp xếp" style="width: 10%" onclick="sortDonHangTable('trangthai')">Trạng thái <i class="fa fa-sort"></i></th>
          <th style="width: 10%">Hành động</th>
      </tr>
  </table>

  <div class="table-content"><table class="table-outline hideImg"><tbody><tr>
    <td style="width: 5%">1</td>
    <td style="width: 7%">1</td>
    <td style="width: 13%">HuyenNguyen<br>(Nguyễn Ngọc Huyền)<br>Mã: 2</td>
    <td style="width: 20%; text-align:right;"><a target="blank" href="chitietsanpham.php?46">
  <p>Tai nghe Bluetooth Chụp Tai HAVIT H663BT [<span style="color:yellow">1</span>]</p>
</a><a target="blank" href="chitietsanpham.php?4">
  <p>Tai nghe Bluetooth AirPods 2 Lightning Charge Apple MV7N2 [<span style="color:yellow">10</span>]</p>
</a></td>
    <td style="width: 15%">34.990.000</td>
    <td style="width: 10%">5/1/2024, 3:19:56 PM</td>
    <td style="width: 10%">Đã giao</td>
    <td style="width: 10%">_</td>
</tr><tr>
    <td style="width: 5%">2</td>
    <td style="width: 7%">2</td>
    <td style="width: 13%">LoanPhanpt<br>(Phan Thị Kim Loan)<br>Mã: 5</td>
    <td style="width: 20%; text-align:right;"><a target="blank" href="chitietsanpham.php?15">
  <p>Tai nghe Bluetooth Chụp Tai HAVIT H667BT  [<span style="color:yellow">2</span>]</p>
</a><a target="blank" href="chitietsanpham.php?9">
  <p>Tai nghe Bluetooth AirPods 3 Lightning Charge Apple MPNY3 [<span style="color:yellow">1</span>]</p>
</a><a target="blank" href="chitietsanpham.php?11">
  <p>Tai nghe Bluetooth AirPods Pro Gen 2(USB-C) Apple MTJV3 [<span style="color:yellow">2</span>]</p>
</a><a target="blank" href="chitietsanpham.php?12">
  <p>Tai nghe Chụp Tai Trẻ em AVA+ KD-662 [<span style="color:yellow">1</span>]</p>
</a></td>
    <td style="width: 15%">17.460.000</td>
    <td style="width: 10%">5/12/2024, 2:34:04 PM</td>
    <td style="width: 10%">Đã giao</td>
    <td style="width: 10%">_</td>
</tr><tr>
    <td style="width: 5%">3</td>
    <td style="width: 7%">3</td>
    <td style="width: 13%">NhatQuyenIT<br>(Lê Song Nhật Quyền)<br>Mã: 7</td>
    <td style="width: 20%; text-align:right;"><a target="blank" href="chitietsanpham.php?3">
  <p>Tai nghe Bluetooth AVA+ FreeGo W26 [<span style="color:yellow">1</span>]</p>
</a><a target="blank" href="chitietsanpham.php?46">
  <p>Tai nghe Bluetooth Chụp Tai HAVIT H663BT [<span style="color:yellow">1</span>]</p>
</a><a target="blank" href="chitietsanpham.php?16">
  <p>Tai nghe HAVIT TW976 [<span style="color:yellow">1</span>]</p>
</a><a target="blank" href="chitietsanpham.php?8">
  <p>Tai nghe Bluetooth Xiaomi Redmi Buds 5 [<span style="color:yellow">2</span>]</p>
</a><a target="blank" href="chitietsanpham.php?7">
  <p>Tai nghe Bluetooth OPPO Enco Buds 2 Pro E510A [<span style="color:yellow">1</span>]</p>
</a><a target="blank" href="chitietsanpham.php?1">
  <p>Tai nghe Bluetooth Samsung Galaxy Buds FE R400N  [<span style="color:yellow">2</span>]</p>
</a><a target="blank" href="chitietsanpham.php?14">
  <p>Tai nghe Có Dây Awei Q50Hi [<span style="color:yellow">1</span>]</p>
</a></td>
    <td style="width: 15%">5.220.000</td>
    <td style="width: 10%">5/12/2024, 2:42:03 PM</td>
    <td style="width: 10%">Đã giao</td>
    <td style="width: 10%">_</td>
</tr><tr>
    <td style="width: 5%">4</td>
    <td style="width: 7%">4</td>
    <td style="width: 13%">NhatQuyenIT<br>(Lê Song Nhật Quyền)<br>Mã: 7</td>
    <td style="width: 20%; text-align:right;"><a target="blank" href="chitietsanpham.php?5">
  <p>Tai nghe Bluetooth Samsung Galaxy Buds 2 Pro R510N  [<span style="color:yellow">1</span>]</p>
</a><a target="blank" href="chitietsanpham.php?11">
  <p>Tai nghe Bluetooth AirPods Pro Gen 2(USB-C) Apple MTJV3 [<span style="color:yellow">1</span>]</p>
</a><a target="blank" href="chitietsanpham.php?2">
  <p>Tai nghe Bluetooth OPPO ENCO Buds 2 ETE41 [<span style="color:yellow">1</span>]</p>
</a></td>
    <td style="width: 15%">10.190.000</td>
    <td style="width: 10%">5/12/2024, 2:44:35 PM</td>
    <td style="width: 10%">Đã hủy</td>
    <td style="width: 10%">_</td>
</tr><tr>
    <td style="width: 5%">5</td>
    <td style="width: 7%">5</td>
    <td style="width: 13%">thuthuha444<br>(Vũ Thị Thu Hà)<br>Mã: 14</td>
    <td style="width: 20%; text-align:right;"><a target="blank" href="chitietsanpham.php?18">
  <p>Tai nghe Chụp Tai Sony MDR - ZX110AP  [<span style="color:yellow">2</span>]</p>
</a><a target="blank" href="chitietsanpham.php?6">
  <p>Tai nghe Bluetooth vivo Air XEW25 [<span style="color:yellow">2</span>]</p>
</a><a target="blank" href="chitietsanpham.php?14">
  <p>Tai nghe Có Dây Awei Q50Hi [<span style="color:yellow">1</span>]</p>
</a><a target="blank" href="chitietsanpham.php?7">
  <p>Tai nghe Bluetooth OPPO Enco Buds 2 Pro E510A [<span style="color:yellow">1</span>]</p>
</a><a target="blank" href="chitietsanpham.php?8">
  <p>Tai nghe Bluetooth Xiaomi Redmi Buds 5 [<span style="color:yellow">1</span>]</p>
</a></td>
    <td style="width: 15%">2.490.000</td>
    <td style="width: 10%">5/13/2024, 2:16:40 AM</td>
    <td style="width: 10%">Chờ duyệt</td>
    <td style="width: 10%"><div class="tooltip">
        <i class="fa fa-check" onclick="capNhatDonHang('5', '2')"></i>
        <span class="tooltiptext">Duyệt</span>
    </div>
    <div class="tooltip">
        <i class="fa fa-remove" onclick="capNhatDonHang('5', '-1')"></i>
        <span class="tooltiptext">Hủy</span>
    </div></td>
</tr></tbody></table></div>

  <div class="table-footer">
      <div class="timTheoNgay">
          Từ ngày: <input type="date" id="fromDate">
          Đến ngày: <input type="date" id="toDate">
          <button onclick="locDonHangTheoKhoangNgay()"><i class="fa fa-search"></i> Tìm</button>
      </div>

      <select name="kieuTimDonHang">
          <option value="ma">Tìm theo mã đơn</option>
          <option value="khachhang">Tìm theo tên khách hàng</option>
          <option value="trangThai">Tìm theo trạng thái</option>
      </select>
      <input type="text" placeholder="Tìm kiếm..." onkeyup="timKiemDonHang(this)">
  </div>

</div> <!-- // don hang -->

<script>
    // ========================= Đơn Hàng ===========================

  function layTatCaDonHang(callback) {
    $.ajax({
      type: "POST",
      url: "php/xulydonhang.php",
      dataType: "json",
      // timeout: 1500, // sau 1.5 giây mà không phản hồi thì dừng => hiện lỗi
      data: {
        request: "getall",
      },
      success: function (data, status, xhr) {
        callback(data);
      },
      error: function (e) {
        Swal.fire({
          type: "error",
          title: "Lỗi lấy dữ liệu đơn Hàng (admin.js > refreshTableDonHang)",
          html: e.responseText,
        });
        callback([]);
      },
    });
  }

  // Vẽ bảng
  function refreshTableDonHang() {
    layTatCaDonHang((data) => {
      addTableDonHang(data);
      TATCA_DONHANG = data;
      console.log(data);
    });
  }
  function addTableDonHang(data) {
    var tc = document
      .getElementsByClassName("donhang")[0]
      .getElementsByClassName("table-content2")[0];
    var s = `<table class="table-outline hideImg">`;

    TONGTIEN = 0;
    for (var i = 0; i < data.length; i++) {
      var d = data[i];

      // Ngày giờ
      var date = new Date(d.NgayLap).toLocaleString();

      //  danh sach san pham
      var dssp = ``;
      for (var ct of d.CTDH) {
        dssp += `<a target="blank" href="chitietsanpham.php?${ct.SP.MaSP}">
        <p>${ct.SP.TenSP} [<span style="color:yellow">${ct.SoLuong}</span>]</p>
      </a>`;
      }

      // Nút bấm Hành động
      let action =
        d.TrangThai == "-1" // Đã hủy
          ? "_"
          : d.TrangThai == "1" // Chờ duyệt
            ? `<div class="tooltip">
              <i class="fa fa-check" onclick="capNhatDonHang('${d.MaHD}', '2')"></i>
              <span class="tooltiptext">Duyệt</span>
          </div>
          <div class="tooltip">
              <i class="fa fa-remove" onclick="capNhatDonHang('${d.MaHD}', '-1')"></i>
              <span class="tooltiptext">Hủy</span>
          </div>`
            : d.TrangThai == "2" // Đã duyệt
              ? `<div class="tooltip">
                <i class="fa fa-check" onclick="capNhatDonHang('${d.MaHD}', '3')"></i>
                <span class="tooltiptext">Giao hàng</span>
            </div>
            <div class="tooltip">
                <i class="fa fa-remove" onclick="capNhatDonHang('${d.MaHD}', '-1')"></i>
                <span class="tooltiptext">Hủy</span>
            </div>`
              : d.TrangThai == "3" // Đang giao
                ? `<div class="tooltip">
              <i class="fa fa-check" onclick="capNhatDonHang('${d.MaHD}', '4')"></i>
              <span class="tooltiptext">Giao xong</span>
          </div>
          <div class="tooltip">
              <i class="fa fa-remove" onclick="capNhatDonHang('${d.MaHD}', '-1')"></i>
              <span class="tooltiptext">Hủy</span>
          </div>`
                : d.TrangThai == "4" // Giao xong
                  ? `_`
                  : "";

      // Người dùng
      let nguoiDung =
        `${d.ND.TaiKhoan}<br/>` +
        `(${d.ND.Ho} ${d.ND.Ten})<br/>` +
        `Mã: ${d.MaND}`;

      s += `<tr>
          <td style="width: 5%">${i + 1}</td>
          <td style="width: 7%">${d.MaHD}</td>
          <td style="width: 13%">${nguoiDung}</td>
          <td style="width: 20%; text-align:right;">${dssp}</td>
          <td style="width: 15%">${numToString(Number(d.TongTien))}</td>
          <td style="width: 10%">${date}</td>
          <td style="width: 10%">${getTenTrangThaiDonHang(d.TrangThai)}</td>
          <td style="width: 10%">${action}</td>
      </tr>`;
      TONGTIEN += Number(d.tongtien);
    }

    s += `</table>`;
    tc.innerHTML = s;
  }

  // Duyệt
  function capNhatDonHang(maDonHang, trangThai) {
    let donhang = TATCA_DONHANG.find((_) => _.MaHD === maDonHang);
    if (!donhang) {
      Swal.fire({
        type: "error",
        title:
          "Không tìm thấy đơn hàng #" + maDonHang + ". Vui lòng tải lại trang.",
        html: e.responseText,
      });
      return;
    }
    if (trangThai == "-1") {
      Swal.fire({
        type: "warning",
        title: "Bạn có chắc muốn Hủy đơn hàng #" + maDonHang + "?",
        text: "Việc này không thể hoàn tác!",
        showDenyButton: true,
        showCancelButton: true,
        confirmButtonText: "Hủy đơn",
        cancelButtonText: "Giữ lại",
      }).then((result) => {
        if (result.value) {
          capNhatDonHangAjax(maDonHang, trangThai);
        }
      });
    } else {
      Swal.fire({
        type: "info",
        title:
          "Cập nhật đơn hàng #" +
          maDonHang +
          " thành " +
          getTenTrangThaiDonHang(trangThai) +
          "?",
        showDenyButton: true,
        showCancelButton: true,
        confirmButtonText: "Đồng ý",
        cancelButtonText: "Hủy",
      }).then((result) => {
        if (result.value) {
          capNhatDonHangAjax(maDonHang, trangThai);
        }
      });
    }
  }

  function capNhatDonHangAjax(maDonHang, trangThai) {
    $.ajax({
      type: "POST",
      url: "php/xulydonhang.php",
      dataType: "json",
      data: {
        request: "capNhatTrangThai",
        maDonHang: maDonHang,
        trangThai: trangThai,
      },
      beforeSend: function () {
        Swal.showLoading();
      },
      success: function (data, status, xhr) {
        console.log(data);
        Swal.fire({
          type: "success",
          title: "Cập nhật trạng thái đơn hàng #" + maDonHang + " thành công",
        });
        refreshTableDonHang();
      },
      error: function (e) {
        console.log(e);
        Swal.fire({
          type: "error",
          title:
            "Lỗi cập nhật trạng thái đơn hàng (admin.js > capNhatDonHangAjax)",
          html: e.responseText,
        });
      },
    });
  }

  function locDonHangTheoKhoangNgay() {
    var from = document.getElementById("fromDate").valueAsDate;
    var to = document.getElementById("toDate").valueAsDate;

    var listTr_table = document
      .getElementsByClassName("donhang")[0]
      .getElementsByClassName("table-content2")[0]
      .getElementsByTagName("tr");
    for (var tr of listTr_table) {
      var td = tr.getElementsByTagName("td")[5].innerHTML;
      var d = new Date(td);

      if (d >= from && d <= to) {
        tr.style.display = "";
      } else {
        tr.style.display = "none";
      }
    }
  }

  function timKiemDonHang(inp) {
    var kieuTim = document.getElementsByName("kieuTimDonHang")[0].value;
    var text = inp.value;

    // Lọc
    var vitriKieuTim = {
      ma: 1,
      khachhang: 2,
      trangThai: 6,
    };

    var listTr_table = document
      .getElementsByClassName("donhang")[0]
      .getElementsByClassName("table-content2")[0]
      .getElementsByTagName("tr");
    for (var tr of listTr_table) {
      var td = tr
        .getElementsByTagName("td")
      [vitriKieuTim[kieuTim]].innerHTML.toLowerCase();

      if (td.indexOf(text.toLowerCase()) < 0) {
        tr.style.display = "none";
      } else {
        tr.style.display = "";
      }
    }
  }

  // Sắp xếp
  function sortDonHangTable(loai) {
    var list = document
      .getElementsByClassName("donhang")[0]
      .getElementsByClassName("table-content2")[0];
    var tr = list.getElementsByTagName("tr");

    quickSort(tr, 0, tr.length - 1, loai, getValueOfTypeInTable_DonHang);
    decrease = !decrease;
  }

  // Lấy giá trị của loại(cột) dữ liệu nào đó trong bảng
  function getValueOfTypeInTable_DonHang(tr, loai) {
    var td = tr.getElementsByTagName("td");
    switch (loai) {
      case "stt":
        return Number(td[0].innerHTML);
      case "ma":
        return new Date(td[1].innerHTML); // chuyển về dạng ngày để so sánh ngày
      case "khach":
        return td[2].innerHTML.toLowerCase(); // lấy tên khách
      case "sanpham":
        return td[3].children.length; // lấy số lượng hàng trong đơn này, length ở đây là số lượng <p>
      case "tongtien":
        return stringToNum(td[4].innerHTML); // trả về dạng giá tiền
      case "ngaygio":
        return new Date(td[5].innerHTML); // chuyển về ngày
      case "trangthai":
        return td[6].innerHTML.toLowerCase(); //
    }
    return false;
  }
</script>